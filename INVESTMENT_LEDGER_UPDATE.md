# 投資交易帳本記錄功能更新

## 更新內容

### 問題描述
1. **持倉明細未顯示**：新增交易後，持倉明細表格未正確顯示
2. **缺少交易記錄**：投資交易未在「資產總覽」的交易明細中顯示

### 解決方案

#### 1. 後端 API 修改（server/routes.ts）

投資交易完成後，現在會自動創建帳本記錄：

**買入交易**：
- 付款帳戶記錄：類型「支出」，分類「股票買入」
- 券商帳戶記錄：類型「收入」，分類「持倉增加」

**賣出交易**：
- 付款帳戶記錄：類型「收入」，分類「股票賣出」
- 券商帳戶記錄：類型「支出」，分類「持倉減少」

記錄內容包含：
- 股票名稱和代號
- 交易數量和價格
- 手續費（如有）

#### 2. 前端刷新機制優化（InvestmentTransactionDialog.tsx）

- 增加帳本記錄查詢刷新
- 使用 `await` 確保所有資料完全載入後再關閉對話框
- 刷新項目：
  - 投資持倉列表
  - 投資交易歷史
  - 資產帳戶餘額
  - 帳本記錄（新增）

## 功能驗證

### 測試步驟

1. **確認資料庫已更新**
   - 執行 `migrations/0002_add_investment_accounts.sql`
   - 參考 `NEON_DATABASE_UPDATE.md` 文件

2. **測試買入交易**
   ```
   - 進入「投資」頁面
   - 點擊「新增交易」
   - 選擇「買入」
   - 填寫：台積電 (2330)，100股，600元，手續費30元
   - 選擇付款帳戶（如：現金）
   - 選擇券商帳戶（如：富邦證券）
   - 提交
   ```

3. **驗證結果**
   - 持倉明細表格顯示：台積電 100股
   - 付款帳戶餘額減少：60,030元
   - 券商帳戶市值增加：60,000元
   - 資產總覽「交易明細」顯示：
     * 股票買入 -60,030元（付款帳戶）
     * 持倉增加 +60,000元（券商帳戶）

4. **測試賣出交易**
   ```
   - 點擊「新增交易」
   - 選擇「賣出」
   - 填寫：台積電 (2330)，50股，610元，手續費20元
   - 提交
   ```

5. **驗證結果**
   - 持倉明細更新：台積電 50股（剩餘）
   - 付款帳戶餘額增加：30,480元（30,500-20手續費）
   - 券商帳戶市值減少：30,500元
   - 交易明細顯示賣出記錄

## 帳本記錄格式

### 買入範例
```
類型：支出
金額：60,030
分類：股票買入
帳戶：現金
備註：買入 台灣積體電路 (2330) 100 股 @ $600 (手續費 $30)
```

```
類型：收入
金額：60,000
分類：持倉增加
帳戶：富邦證券
備註：買入 台灣積體電路 (2330) 100 股
```

### 賣出範例
```
類型：收入
金額：30,480
分類：股票賣出
帳戶：現金
備註：賣出 台灣積體電路 (2330) 50 股 @ $610 (手續費 $20)
```

```
類型：支出
金額：30,500
分類：持倉減少
帳戶：富邦證券
備註：賣出 台灣積體電路 (2330) 50 股
```

## 影響範圍

### 修改的檔案
1. `server/routes.ts` - 投資交易 API（第 556-745 行）
2. `client/src/components/InvestmentTransactionDialog.tsx` - 對話框刷新邏輯

### 相關頁面
- 投資頁面（Investment.tsx）- 持倉明細顯示
- 資產總覽（AssetOverview.tsx）- 交易明細顯示
- 記帳頁面（Ledger.tsx）- 完整交易記錄

## 注意事項

1. **手續費處理**
   - 買入：從付款帳戶額外扣除
   - 賣出：從賣出金額中扣除
   - 不影響持倉成本計算

2. **平均成本**
   - 買入時自動計算加權平均成本
   - 賣出時不影響剩餘持倉的平均成本

3. **市值更新**
   - 券商帳戶的餘額（balance）反映總市值
   - 根據所有持倉的當前價格計算

4. **交易記錄**
   - 投資交易表（investment_transactions）保留完整歷史
   - 帳本記錄（ledger_entries）用於資產總覽顯示
   - 兩者互相補充，不重複

## 後續優化建議

1. **交易類別擴充**
   - 股息收入
   - 股票股利
   - 現金股利

2. **報表功能**
   - 投資損益報表
   - 持倉明細報表
   - 交易手續費統計

3. **自動更新**
   - 即時股價更新
   - 匯率自動更新（外股）
   - 持倉市值自動刷新

4. **進階功能**
   - 停損停利設定
   - 成本價提醒
   - 投資目標追蹤
