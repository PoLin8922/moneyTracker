<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æŠ•è³‡å¸³æˆ¶åŒæ­¥æ¸¬è©¦å·¥å…·</title>
  <style>
    body {
      font-family: system-ui, -apple-system, sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .card {
      background: white;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    h1 { color: #333; margin-top: 0; }
    h2 { color: #666; font-size: 18px; margin-top: 0; }
    button {
      background: #0070f3;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      margin-right: 10px;
    }
    button:hover { background: #0051cc; }
    button:disabled { background: #ccc; cursor: not-allowed; }
    .status { padding: 10px; border-radius: 4px; margin: 10px 0; }
    .success { background: #d4edda; color: #155724; }
    .error { background: #f8d7da; color: #721c24; }
    .warning { background: #fff3cd; color: #856404; }
    .info { background: #d1ecf1; color: #0c5460; }
    pre {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 4px;
      overflow-x: auto;
      font-size: 12px;
      line-height: 1.5;
    }
    .loading { display: inline-block; animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    table {
      width: 100%;
      border-collapse: collapse;
      margin: 10px 0;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: left;
    }
    th { background: #f8f9fa; font-weight: 600; }
  </style>
</head>
<body>
  <h1>ğŸ” æŠ•è³‡å¸³æˆ¶åŒæ­¥æ¸¬è©¦å·¥å…·</h1>
  
  <div class="card">
    <h2>1ï¸âƒ£ æ¸¬è©¦åƒ¹æ ¼åŒæ­¥ API</h2>
    <button onclick="testSyncAPI()">åŸ·è¡ŒåŒæ­¥æ¸¬è©¦</button>
    <div id="syncResult"></div>
  </div>

  <div class="card">
    <h2>2ï¸âƒ£ æŸ¥çœ‹æŒå€‰è³‡æ–™</h2>
    <button onclick="fetchHoldings()">è¼‰å…¥æŒå€‰åˆ—è¡¨</button>
    <div id="holdingsResult"></div>
  </div>

  <div class="card">
    <h2>3ï¸âƒ£ æŸ¥çœ‹æŠ•è³‡å¸³æˆ¶é¤˜é¡</h2>
    <button onclick="fetchAccounts()">è¼‰å…¥å¸³æˆ¶åˆ—è¡¨</button>
    <div id="accountsResult"></div>
  </div>

  <div class="card">
    <h2>4ï¸âƒ£ é©—è­‰é¤˜é¡è¨ˆç®—</h2>
    <button onclick="validateBalances()">é©—è­‰å¸³æˆ¶é¤˜é¡</button>
    <div id="validationResult"></div>
  </div>

  <div class="card">
    <h2>5ï¸âƒ£ è‡ªå‹•åŒæ­¥ç›£æ§ï¼ˆæ¨¡æ“¬è³‡ç”¢ç¸½è¦½é é¢ï¼‰</h2>
    <button onclick="startAutoSync()" id="startBtn">é–‹å§‹è‡ªå‹•åŒæ­¥</button>
    <button onclick="stopAutoSync()" id="stopBtn" disabled>åœæ­¢åŒæ­¥</button>
    <div id="autoSyncResult"></div>
  </div>

  <script>
    let syncInterval = null;
    let syncCount = 0;
    let holdings = [];
    let accounts = [];

    // æ¸¬è©¦åŒæ­¥ API
    async function testSyncAPI() {
      const resultDiv = document.getElementById('syncResult');
      resultDiv.innerHTML = '<div class="status info">â³ æ­£åœ¨åŒæ­¥...</div>';
      
      try {
        const response = await fetch('/api/investments/sync-prices', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        
        resultDiv.innerHTML = `
          <div class="status success">
            âœ… åŒæ­¥æˆåŠŸï¼
          </div>
          <pre>${JSON.stringify(data, null, 2)}</pre>
          <div class="status ${data.accountsUpdated > 0 ? 'success' : 'warning'}">
            ${data.accountsUpdated > 0 
              ? `âœ… å·²æ›´æ–° ${data.accountsUpdated} å€‹æŠ•è³‡å¸³æˆ¶çš„é¤˜é¡` 
              : 'âš ï¸ æ²’æœ‰æ›´æ–°ä»»ä½•å¸³æˆ¶é¤˜é¡ï¼ˆå¯èƒ½æ˜¯å¾Œç«¯ä»£ç¢¼æœªéƒ¨ç½²ï¼‰'}
          </div>
        `;
      } catch (error) {
        resultDiv.innerHTML = `
          <div class="status error">âŒ åŒæ­¥å¤±æ•—: ${error.message}</div>
          <p>å¯èƒ½åŸå› ï¼š</p>
          <ul>
            <li>æœªç™»å…¥</li>
            <li>å¾Œç«¯æœå‹™æœªå•Ÿå‹•</li>
            <li>ç¶²è·¯é€£ç·šå•é¡Œ</li>
          </ul>
        `;
      }
    }

    // è¼‰å…¥æŒå€‰åˆ—è¡¨
    async function fetchHoldings() {
      const resultDiv = document.getElementById('holdingsResult');
      resultDiv.innerHTML = '<div class="status info">â³ è¼‰å…¥ä¸­...</div>';
      
      try {
        const response = await fetch('/api/investments/holdings');
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        
        holdings = await response.json();
        
        if (holdings.length === 0) {
          resultDiv.innerHTML = '<div class="status warning">âš ï¸ æ²’æœ‰æŒå€‰è¨˜éŒ„</div>';
          return;
        }

        // è¨ˆç®—æ¯å€‹å¸³æˆ¶çš„ç¸½å¸‚å€¼
        const accountTotals = {};
        holdings.forEach(h => {
          const marketValue = parseFloat(h.quantity) * parseFloat(h.currentPrice);
          if (!accountTotals[h.brokerAccountId]) {
            accountTotals[h.brokerAccountId] = { total: 0, count: 0 };
          }
          accountTotals[h.brokerAccountId].total += marketValue;
          accountTotals[h.brokerAccountId].count++;
        });
        
        let html = `<div class="status success">âœ… æ‰¾åˆ° ${holdings.length} ç­†æŒå€‰</div>`;
        html += '<table><thead><tr><th>ä»£ç¢¼</th><th>åç¨±</th><th>æ•¸é‡</th><th>ç¾åƒ¹</th><th>å¸‚å€¼</th><th>åˆ¸å•†å¸³æˆ¶ID</th></tr></thead><tbody>';
        
        holdings.forEach(h => {
          const marketValue = parseFloat(h.quantity) * parseFloat(h.currentPrice);
          html += `
            <tr>
              <td><b>${h.ticker}</b></td>
              <td>${h.name}</td>
              <td>${h.quantity}</td>
              <td>$${parseFloat(h.currentPrice).toFixed(2)}</td>
              <td>$${marketValue.toFixed(2)}</td>
              <td><code>${h.brokerAccountId.substring(0, 8)}...</code></td>
            </tr>
          `;
        });
        html += '</tbody></table>';

        html += '<h3>å„å¸³æˆ¶æ‡‰æœ‰çš„é¤˜é¡ï¼š</h3>';
        html += '<table><thead><tr><th>åˆ¸å•†å¸³æˆ¶ID</th><th>æŒå€‰æ•¸é‡</th><th>æ‡‰æœ‰ç¸½å¸‚å€¼</th></tr></thead><tbody>';
        Object.entries(accountTotals).forEach(([id, data]) => {
          html += `
            <tr>
              <td><code>${id.substring(0, 8)}...</code></td>
              <td>${data.count} ç­†</td>
              <td><b>$${data.total.toFixed(2)}</b></td>
            </tr>
          `;
        });
        html += '</tbody></table>';
        
        resultDiv.innerHTML = html;
      } catch (error) {
        resultDiv.innerHTML = `<div class="status error">âŒ è¼‰å…¥å¤±æ•—: ${error.message}</div>`;
      }
    }

    // è¼‰å…¥å¸³æˆ¶åˆ—è¡¨
    async function fetchAccounts() {
      const resultDiv = document.getElementById('accountsResult');
      resultDiv.innerHTML = '<div class="status info">â³ è¼‰å…¥ä¸­...</div>';
      
      try {
        const response = await fetch('/api/assets');
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        
        accounts = await response.json();
        const investmentAccounts = accounts.filter(a => 
          ['å°è‚¡', 'ç¾è‚¡', 'åŠ å¯†è²¨å¹£'].includes(a.type)
        );
        
        if (investmentAccounts.length === 0) {
          resultDiv.innerHTML = '<div class="status warning">âš ï¸ æ²’æœ‰æŠ•è³‡å¸³æˆ¶</div>';
          return;
        }
        
        let html = `<div class="status success">âœ… æ‰¾åˆ° ${investmentAccounts.length} å€‹æŠ•è³‡å¸³æˆ¶</div>`;
        html += '<table><thead><tr><th>å¸³æˆ¶åç¨±</th><th>é¡å‹</th><th>é¤˜é¡</th><th>æ›´æ–°æ™‚é–“</th><th>å¸³æˆ¶ID</th></tr></thead><tbody>';
        
        investmentAccounts.forEach(a => {
          const updatedAt = new Date(a.updatedAt);
          const isRecent = (Date.now() - updatedAt.getTime()) < 60000; // 1åˆ†é˜å…§
          html += `
            <tr>
              <td><b>${a.accountName}</b></td>
              <td>${a.type}</td>
              <td><b>$${parseFloat(a.balance).toFixed(2)}</b></td>
              <td class="${isRecent ? 'success' : 'warning'}">
                ${updatedAt.toLocaleString('zh-TW')}
                ${isRecent ? 'âœ…' : 'âš ï¸ è¶…é1åˆ†é˜æœªæ›´æ–°'}
              </td>
              <td><code>${a.id.substring(0, 8)}...</code></td>
            </tr>
          `;
        });
        html += '</tbody></table>';
        
        resultDiv.innerHTML = html;
      } catch (error) {
        resultDiv.innerHTML = `<div class="status error">âŒ è¼‰å…¥å¤±æ•—: ${error.message}</div>`;
      }
    }

    // é©—è­‰é¤˜é¡è¨ˆç®—
    async function validateBalances() {
      const resultDiv = document.getElementById('validationResult');
      
      if (holdings.length === 0 || accounts.length === 0) {
        resultDiv.innerHTML = '<div class="status warning">âš ï¸ è«‹å…ˆè¼‰å…¥æŒå€‰å’Œå¸³æˆ¶è³‡æ–™</div>';
        return;
      }
      
      // è¨ˆç®—æ¯å€‹å¸³æˆ¶çš„é æœŸé¤˜é¡
      const expectedBalances = {};
      holdings.forEach(h => {
        const marketValue = parseFloat(h.quantity) * parseFloat(h.currentPrice);
        if (!expectedBalances[h.brokerAccountId]) {
          expectedBalances[h.brokerAccountId] = 0;
        }
        expectedBalances[h.brokerAccountId] += marketValue;
      });
      
      // æ¯”å°å¯¦éš›é¤˜é¡
      let html = '<table><thead><tr><th>å¸³æˆ¶åç¨±</th><th>é æœŸé¤˜é¡</th><th>å¯¦éš›é¤˜é¡</th><th>å·®ç•°</th><th>ç‹€æ…‹</th></tr></thead><tbody>';
      let allMatch = true;
      
      Object.entries(expectedBalances).forEach(([accountId, expected]) => {
        const account = accounts.find(a => a.id === accountId);
        if (!account) {
          html += `
            <tr>
              <td colspan="5" class="error">âŒ æ‰¾ä¸åˆ°å¸³æˆ¶ ${accountId}</td>
            </tr>
          `;
          allMatch = false;
          return;
        }
        
        const actual = parseFloat(account.balance);
        const diff = Math.abs(actual - expected);
        const matches = diff < 0.01; // å®¹è¨±0.01çš„èª¤å·®
        
        html += `
          <tr>
            <td>${account.accountName}</td>
            <td>$${expected.toFixed(2)}</td>
            <td>$${actual.toFixed(2)}</td>
            <td>${diff > 0.01 ? `$${diff.toFixed(2)}` : '-'}</td>
            <td class="${matches ? 'success' : 'error'}">
              ${matches ? 'âœ… æ­£ç¢º' : 'âŒ ä¸ç¬¦'}
            </td>
          </tr>
        `;
        
        if (!matches) allMatch = false;
      });
      html += '</tbody></table>';
      
      if (allMatch) {
        resultDiv.innerHTML = `
          <div class="status success">âœ… æ‰€æœ‰å¸³æˆ¶é¤˜é¡éƒ½æ­£ç¢ºï¼</div>
          ${html}
        `;
      } else {
        resultDiv.innerHTML = `
          <div class="status error">
            âŒ æœ‰å¸³æˆ¶é¤˜é¡ä¸æ­£ç¢ºï¼<br>
            å»ºè­°åŸ·è¡Œã€Œæ¸¬è©¦åƒ¹æ ¼åŒæ­¥ APIã€ä¾†æ›´æ–°é¤˜é¡ã€‚
          </div>
          ${html}
        `;
      }
    }

    // é–‹å§‹è‡ªå‹•åŒæ­¥
    function startAutoSync() {
      if (syncInterval) return;
      
      syncCount = 0;
      document.getElementById('startBtn').disabled = true;
      document.getElementById('stopBtn').disabled = false;
      
      const resultDiv = document.getElementById('autoSyncResult');
      resultDiv.innerHTML = '<div class="status success">âœ… è‡ªå‹•åŒæ­¥å·²å•Ÿå‹•ï¼ˆæ¯ 10 ç§’ä¸€æ¬¡ï¼‰</div><div id="syncLogs"></div>';
      
      const performSync = async () => {
        syncCount++;
        const logsDiv = document.getElementById('syncLogs');
        const time = new Date().toLocaleTimeString('zh-TW');
        
        try {
          const response = await fetch('/api/investments/sync-prices', { method: 'POST' });
          const data = await response.json();
          
          logsDiv.innerHTML = `
            <div class="status success">
              [${time}] ç¬¬ ${syncCount} æ¬¡åŒæ­¥æˆåŠŸ - 
              æ›´æ–° ${data.updated}/${data.total} ç­†æŒå€‰ï¼Œ
              ${data.accountsUpdated} å€‹å¸³æˆ¶
            </div>
          ` + logsDiv.innerHTML;
        } catch (error) {
          logsDiv.innerHTML = `
            <div class="status error">
              [${time}] ç¬¬ ${syncCount} æ¬¡åŒæ­¥å¤±æ•—: ${error.message}
            </div>
          ` + logsDiv.innerHTML;
        }
      };
      
      performSync(); // ç«‹å³åŸ·è¡Œä¸€æ¬¡
      syncInterval = setInterval(performSync, 10000);
    }

    // åœæ­¢è‡ªå‹•åŒæ­¥
    function stopAutoSync() {
      if (syncInterval) {
        clearInterval(syncInterval);
        syncInterval = null;
      }
      
      document.getElementById('startBtn').disabled = false;
      document.getElementById('stopBtn').disabled = true;
      
      const resultDiv = document.getElementById('autoSyncResult');
      resultDiv.innerHTML += '<div class="status warning">â¸ï¸ è‡ªå‹•åŒæ­¥å·²åœæ­¢</div>';
    }
  </script>
</body>
</html>
